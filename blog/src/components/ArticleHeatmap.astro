---
import { getCollection } from "astro:content";
import { Icon } from "astro-icon/components";

// 記事データを取得
const posts = await getCollection("blog", ({ data }) => data.published);

// 2年前の日付を取得
const now = new Date();
const oneYearAgo = new Date(now);
oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 2);

// 週の開始日を取得（日曜日）
function getWeekStart(date: Date): string {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day;
  d.setDate(diff);
  d.setHours(0, 0, 0, 0);
  return d.toISOString().split("T")[0];
}

// 週ごとの投稿数を集計
const weeklyPosts = new Map<string, number>();

posts.forEach(post => {
  const pubDate = new Date(post.data.pubDatetime);
  if (pubDate >= oneYearAgo && pubDate <= now) {
    const weekStart = getWeekStart(pubDate);
    weeklyPosts.set(weekStart, (weeklyPosts.get(weekStart) || 0) + 1);
  }
});

// 全ての週を生成（52週）
const weeks: Array<{ date: string; count: number }> = [];
const currentWeek = new Date(oneYearAgo);

while (currentWeek <= now) {
  const weekStart = getWeekStart(currentWeek);
  weeks.push({
    date: weekStart,
    count: weeklyPosts.get(weekStart) || 0,
  });
  currentWeek.setDate(currentWeek.getDate() + 7);
}

// 最大投稿数を取得（色の強度計算用）
const maxCount = Math.max(...weeks.map(w => w.count), 1);

// カラーレベルを計算
function getColorLevel(count: number): number {
  if (count === 0) return 0;
  const percentage = count / maxCount;
  if (percentage <= 0.25) return 1;
  if (percentage <= 0.5) return 2;
  if (percentage <= 0.75) return 3;
  return 4;
}

// 週を縦に5つずつ並べるためにグループ化
const ROWS = 5;
const columns: Array<Array<{ date: string; count: number; index: number }>> =
  [];

for (let col = 0; col < Math.ceil(weeks.length / ROWS); col++) {
  const column: Array<{ date: string; count: number; index: number }> = [];
  for (let row = 0; row < ROWS; row++) {
    const index = col * ROWS + row;
    if (index < weeks.length) {
      column.push({ ...weeks[index], index });
    } else {
      column.push({ date: "", count: -1, index: -1 });
    }
  }
  columns.push(column);
}

// 月のラベルを生成（簡素化版）
function getMonthLabels() {
  const labels: Array<{ month: string; colIndex: number }> = [];
  let lastMonth = -1;

  columns.forEach((column, colIndex) => {
    const firstWeek = column.find(w => w.date !== "");
    if (firstWeek) {
      const date = new Date(firstWeek.date);
      const month = date.getMonth();
      // 月が変わった時、または4列ごとにラベルを表示
      if (month !== lastMonth && (colIndex === 0 || colIndex % 4 === 0)) {
        labels.push({
          // YY/MM形式に変更
          month: date.toLocaleDateString("ja-JP", {
            year: "2-digit",
            month: "2-digit",
          }),
          colIndex,
        });
        lastMonth = month;
      }
    }
  });

  return labels;
}

const monthLabels = getMonthLabels();

// GitHubスタイルのカラースキーム
const colorSchemes = {
  light: {
    0: "#ebedf0",
    1: "#9be9a8",
    2: "#40c463",
    3: "#30a14e",
    4: "#216e39",
  },
  dark: {
    0: "#2f3031",
    1: "#0e4429",
    2: "#006d32",
    3: "#26a641",
    4: "#39d353",
  },
};
---

<section class="py-4">
  <div class="mb-4 flex flex-wrap items-center justify-between gap-4">
    <h3 class="text-lg font-semibold">
      <Icon
        name="tabler:chart-histogram"
        class="me-1 mb-1 inline-block size-6"
      />
      Article Heatmap
    </h3>
    <div class="flex items-center gap-1 text-xs">
      <span class="mx-1 text-gray-600 dark:text-gray-400">Low</span>
      {
        [0, 1, 2, 3, 4].map(level => {
          var heatStyle = `
            --heat: ${colorSchemes.light[level as keyof typeof colorSchemes.light]};
            --heat-dark: ${colorSchemes.dark[level as keyof typeof colorSchemes.dark]};
          `
          return (
            <div
              class:list={[
                "h-3 w-3 rounded-sm border border-gray-200/60 dark:border-gray-700/40",
                "bg-[var(--heat)] dark:bg-[var(--heat-dark)]",
              ]}
              style={heatStyle}
            />
          )
        })
      }
      <span class="mx-1 text-gray-600 dark:text-gray-400">High</span>
    </div>
  </div>

  <div class="relative overflow-x-auto pt-6">
    <div
      class="absolute top-0 left-0 h-5 w-full text-xs text-gray-600 dark:text-gray-400"
    >
      {
        monthLabels.map(label => (
          <span
            class="absolute whitespace-nowrap"
            style={`left: ${label.colIndex * 15}px`}
          >
            {label.month}
          </span>
        ))
      }
    </div>

    <div class="flex flex-nowrap items-start gap-[3px]">
      {
        columns.map(column => (
          <div class="flex flex-col gap-[3px]">
            {column.map(week => {
              if (week.count === -1) {
                return <div class="h-3 w-3 md:h-3 md:w-3" />;
              }
              const level = getColorLevel(week.count);
              const date = new Date(week.date);
              const dateStr = date.toLocaleDateString("ja-JP");
              const heatStyle = `
                --heat: ${colorSchemes.light[level as keyof typeof colorSchemes.light]};
                --heat-dark: ${colorSchemes.dark[level as keyof typeof colorSchemes.dark]};
              `;
              return (
                <div
                  class:list={[
                    "h-3 w-3 cursor-pointer rounded-xs border transition-all dark:border-gray-700/40",
                    "hover:ring-2 hover:ring-gray-400/50 dark:hover:ring-gray-500/50",
                    "bg-[var(--heat)] dark:bg-[var(--heat-dark)]",
                  ]}
                  style={heatStyle}
                  data-date={dateStr}
                  data-count={week.count}
                  title={`${dateStr}の週: ${week.count}件の投稿`}
                />
              );
            })}
          </div>
        ))
      }
    </div>
  </div>
</section>
