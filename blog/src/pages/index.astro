---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import IndexSide from "@/components/IndexSide.astro";
import LinkButton from "@/components/LinkButton.astro";
import Card from "@/components/Card.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import { Icon } from "astro-icon/components";
import { SITE } from "@/config";

const posts = await getCollection("blog");

const sortedPosts = getSortedPosts(posts);
const recentPosts = sortedPosts;
---

<Layout>
  <Header />
  <main id="main-content" data-layout="index" class="app-layout">
    <div class="mt-8 md:flex flex-row gap-8">
      <div class="md:flex-1 md:border-r md:pb-8">
        {
          recentPosts.length > 0 && (
            <section id="recent-posts" class="pb-2">
              <h2 class="text-2xl font-semibold tracking-wide">Recent Posts</h2>
              <ul>
                {recentPosts.map(
                  (data, index) =>
                    index < SITE.postPerIndex && <Card variant="h3" {...data} />
                )}
              </ul>
            </section>
          )
        }
        <div class="mt-2 md:mb-2 text-center md:text-left">
          <LinkButton href="/posts/">
            All Posts
            <Icon name="tabler:arrow-right" class="inline-block rtl:-rotate-180" />
          </LinkButton>
        </div>
      </div>
      <IndexSide />
    </div>
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
